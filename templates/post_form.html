<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ê²Œì‹œë¬¼ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pri:#2563eb; --ok:#065f46; --err:#b91c1c; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .wrap { max-width: 860px; margin: 0 auto; display: grid; gap: 1rem; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 1rem 1.25rem; }
    h2 { margin: 0.2rem 0 0.8rem; font-size: 1.25rem; }
    .row { margin-bottom: 0.6rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
    input[type="text"], textarea { width: 100%; box-sizing: border-box; padding: 0.6rem; border: 1px solid #ccc; border-radius: 8px; }
    textarea { min-height: 120px; resize: vertical; }
    .hor { display: flex; gap: 0.75rem; align-items: center; }
    .muted { color: #666; font-size: 0.9rem; }
    button { padding: 0.6rem 1rem; border: 0; background: var(--pri); color: #fff; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .msg { margin-top: 0.5rem; font-size: 0.95rem; }
    .msg.ok { color: var(--ok); }
    .msg.err { color: var(--err); }
    .pill { display: inline-block; padding: 0.25rem 0.5rem; background: #eef2ff; color: #3730a3; border-radius: 999px; font-size: 0.85rem; }
    .grid-2 { display: grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    @media (max-width: 800px) { .grid-2 { grid-template-columns: 1fr; } }
    a.btn-link { color: var(--pri); text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hor" style="justify-content: space-between;">
        <h2>ê²Œì‹œë¬¼/ëŒ“ê¸€/ì¢‹ì•„ìš” í…ŒìŠ¤íŠ¸</h2>
        <div class="hor" style="gap:0.5rem">
          <a class="btn-link" href="/login_page">ë¡œê·¸ì¸ í˜ì´ì§€</a>
          <button id="logoutBtn" type="button" style="background:#111827">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <div class="muted">ì„¸ì…˜ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</div>
      <div class="muted">ë§ˆì§€ë§‰ìœ¼ë¡œ ìƒì„±í•œ ê²Œì‹œë¬¼ ID: <span id="lastPostId" class="pill">ì—†ìŒ</span></div>
    </div>

    <div class="card">
      <h2>1) ê²Œì‹œë¬¼ ì‘ì„± (POST /posts)</h2>
      <form id="postForm">
        <div class="row">
          <label for="title">ì œëª©</label>
          <input id="title" name="title" type="text" placeholder="ì œëª©" required />
        </div>
        <div class="row">
          <label for="content">ë‚´ìš©</label>
          <textarea id="content" name="content" placeholder="ê²Œì‹œë¬¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
        </div>
        <div class="row hor">
          <label class="hor" style="gap:0.4rem">
            <input id="post_anonymous" type="checkbox" />
            ìµëª…ìœ¼ë¡œ ì‘ì„±
          </label>
          <button id="postBtn" type="submit">ê²Œì‹œë¬¼ ì‘ì„±</button>
        </div>
        <div id="postMsg" class="msg"></div>
      </form>
    </div>

    <div class="grid-2">
      <div class="card">
        <h2>2) ëŒ“ê¸€ ì‘ì„± (POST /posts/<id>/comments)</h2>
        <form id="commentForm">
          <div class="row">
            <label for="comment_post_id">ê²Œì‹œë¬¼ ID</label>
            <input id="comment_post_id" type="text" placeholder="ì˜ˆ: 1 (ë¯¸ì…ë ¥ ì‹œ ë§ˆì§€ë§‰ ìƒì„± ID ì‚¬ìš©)" />
          </div>
          <div class="row">
            <label for="comment_content">ëŒ“ê¸€ ë‚´ìš©</label>
            <textarea id="comment_content" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
          </div>
          <div class="row hor">
            <label class="hor" style="gap:0.4rem">
              <input id="comment_anonymous" type="checkbox" />
              ìµëª… ëŒ“ê¸€
            </label>
            <button id="commentBtn" type="submit">ëŒ“ê¸€ ì‘ì„±</button>
          </div>
          <div id="commentMsg" class="msg"></div>
        </form>
      </div>

      <div class="card">
        <h2>3) ì¢‹ì•„ìš” í† ê¸€ (POST /posts/<id>/like)</h2>
        <form id="likeForm">
          <div class="row">
            <label for="like_post_id">ê²Œì‹œë¬¼ ID</label>
            <input id="like_post_id" type="text" placeholder="ì˜ˆ: 1 (ë¯¸ì…ë ¥ ì‹œ ë§ˆì§€ë§‰ ìƒì„± ID ì‚¬ìš©)" />
          </div>
          <div class="row hor">
            <button id="likeBtn" type="submit">ì¢‹ì•„ìš” í† ê¸€</button>
          </div>
          <div id="likeMsg" class="msg"></div>
        </form>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>4) ê²Œì‹œë¬¼ ëª©ë¡ ì¡°íšŒ (GET /posts)</h2>
      <div class="row hor">
        <label>í˜ì´ì§€ <input id="list_page" type="number" value="1" min="1" style="width:80px"></label>
        <label>í¬ê¸° <input id="list_size" type="number" value="10" min="1" max="100" style="width:80px"></label>
        <button id="listLoadBtn" type="button">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="listPrevBtn" type="button">ì´ì „</button>
        <button id="listNextBtn" type="button">ë‹¤ìŒ</button>
        <span id="listInfo" class="muted"></span>
      </div>
      <div id="postsContainer"></div>
    </div>
  </div>

  <script>
    let lastPostId = null;

    const $ = (sel) => document.querySelector(sel);
    const setMsg = (el, text, ok = false, err = false) => {
      el.textContent = text || '';
      el.className = 'msg' + (ok ? ' ok' : err ? ' err' : '');
    };
    const withSession = { credentials: 'include' };

    // ë¡œê·¸ì•„ì›ƒ
    $('#logoutBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/logout', { method: 'POST', ...withSession });
        if (res.ok) {
          alert('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
          window.location.href = '/login_page';
        } else {
          alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
        }
      } catch (e) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
      }
    });

    // ê²Œì‹œë¬¼ ì‘ì„±
    $('#postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = $('#postMsg');
      setMsg(msg, '');
      $('#postBtn').disabled = true;

      const title = $('#title').value.trim();
      const content = $('#content').value.trim();
      const is_anonymous = $('#post_anonymous').checked;

      if (!title || !content) {
        setMsg(msg, 'ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', false, true);
        $('#postBtn').disabled = false;
        return;
      }

      try {
        const res = await fetch('/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          ...withSession,
          body: JSON.stringify({ title, content, is_anonymous })
        });
        const data = await res.json();
        if (res.status === 201 && data.status === 'success') {
          lastPostId = data.post_id;
          $('#lastPostId').textContent = String(lastPostId);
          setMsg(msg, `ê²Œì‹œë¬¼ ì‘ì„± ì„±ê³µ (post_id=${lastPostId})`, true, false);
          // ëŒ“ê¸€/ì¢‹ì•„ìš” ì…ë ¥ê°’ì— ìë™ ë°˜ì˜
          if ($('#comment_post_id').value.trim() === '') $('#comment_post_id').value = lastPostId;
          if ($('#like_post_id').value.trim() === '') $('#like_post_id').value = lastPostId;
        } else {
          setMsg(msg, data.message || 'ì‘ì„± ì‹¤íŒ¨', false, true);
        }
      } catch (err) {
        setMsg(msg, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false, true);
      } finally {
        $('#postBtn').disabled = false;
      }
    });

    // ëŒ“ê¸€ ì‘ì„±
    $('#commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = $('#commentMsg');
      setMsg(msg, '');
      $('#commentBtn').disabled = true;

      const pidRaw = $('#comment_post_id').value.trim();
      const pid = pidRaw || (lastPostId != null ? String(lastPostId) : '');
      if (!pid) {
        setMsg(msg, 'ê²Œì‹œë¬¼ IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¨¼ì € ê²Œì‹œë¬¼ì„ ìƒì„±í•˜ì„¸ìš”.', false, true);
        $('#commentBtn').disabled = false;
        return;
      }
      const content = $('#comment_content').value.trim();
      const is_anonymous = $('#comment_anonymous').checked;
      if (!content) {
        setMsg(msg, 'ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', false, true);
        $('#commentBtn').disabled = false;
        return;
      }

      try {
        const res = await fetch(`/posts/${encodeURIComponent(pid)}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          ...withSession,
          body: JSON.stringify({ content, is_anonymous })
        });
        const data = await res.json();
        if (res.status === 201 && data.status === 'success') {
          setMsg(msg, `ëŒ“ê¸€ ì‘ì„± ì„±ê³µ (comment_id=${data.comment_id})`, true, false);
        } else {
          setMsg(msg, data.message || 'ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨', false, true);
        }
      } catch (err) {
        setMsg(msg, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false, true);
      } finally {
        $('#commentBtn').disabled = false;
      }
    });

    // ì¢‹ì•„ìš” í† ê¸€
    $('#likeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = $('#likeMsg');
      setMsg(msg, '');
      $('#likeBtn').disabled = true;

      const pidRaw = $('#like_post_id').value.trim();
      const pid = pidRaw || (lastPostId != null ? String(lastPostId) : '');
      if (!pid) {
        setMsg(msg, 'ê²Œì‹œë¬¼ IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¨¼ì € ê²Œì‹œë¬¼ì„ ìƒì„±í•˜ì„¸ìš”.', false, true);
        $('#likeBtn').disabled = false;
        return;
      }

      try {
        const res = await fetch(`/posts/${encodeURIComponent(pid)}/like`, {
          method: 'POST',
          ...withSession
        });
        const data = await res.json();
        if (res.ok && data.status === 'success') {
          setMsg(msg, `liked=${data.liked ? 'true' : 'false'}, like_count=${data.like_count}`, true, false);
        } else {
          setMsg(msg, data.message || 'ì¢‹ì•„ìš” ì‹¤íŒ¨', false, true);
        }
      } catch (err) {
        setMsg(msg, 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false, true);
      } finally {
        $('#likeBtn').disabled = false;
      }
    });
    // ê²Œì‹œë¬¼ ëª©ë¡ ì¡°íšŒ
    const state = { page: 1, size: 10, total: 0 };

    function renderPosts(payload) {
      const c = document.getElementById('postsContainer');
      const items = (payload && payload.items) || [];
      state.page = payload.page;
      state.size = payload.size;
      state.total = payload.total;

      const $lp = document.getElementById('list_page');
      const $ls = document.getElementById('list_size');
      const $info = document.getElementById('listInfo');

      if ($lp) $lp.value = state.page;
      if ($ls) $ls.value = state.size;
      if ($info) {
        const totalPages = Math.max(1, Math.ceil(state.total / state.size));
        $info.textContent = `í˜ì´ì§€ ${state.page}/${totalPages}, ì „ì²´ ${state.total}`;
      }

      if (!c) return;
      if (!items.length) {
        c.innerHTML = '<div class="muted">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      c.innerHTML = items.map((it) => `
        <div class="card" style="margin-top:0.5rem">
          <div class="hor" style="justify-content: space-between;">
            <strong>${it.title ? escapeHtml(it.title) : '(ì œëª© ì—†ìŒ)'}</strong>
            <span class="pill">${it.student_name || 'ìµëª…'}</span>
          </div>
          <div class="muted" style="margin-top:0.4rem; white-space: pre-wrap;">${escapeHtml(it.content || '')}</div>
          <div class="muted" style="margin-top:0.4rem">
            â¤ï¸ ${it.like_count} Â· ğŸ’¬ ${it.comment_count} Â· ${it.created_at}
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&')
        .replace(/</g, '<')
        .replace(/>/g, '>');
    }

    async function loadPosts(page, size) {
      try {
        const p = page || Number(document.getElementById('list_page').value) || 1;
        const s = size || Number(document.getElementById('list_size').value) || 10;
        const res = await fetch(`/posts?page=${encodeURIComponent(p)}&size=${encodeURIComponent(s)}`, { ...withSession });
        const data = await res.json();
        if (res.ok && data.status === 'success') {
          renderPosts(data);
        } else {
          alert(data.message || 'ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        }
      } catch (e) {
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    (function bindListEvents() {
      const $lp = document.getElementById('list_page');
      const $ls = document.getElementById('list_size');
      const $load = document.getElementById('listLoadBtn');
      const $prev = document.getElementById('listPrevBtn');
      const $next = document.getElementById('listNextBtn');

      if ($load) {
        $load.addEventListener('click', () => loadPosts());
      }
      if ($prev) {
        $prev.addEventListener('click', () => {
          const p = Math.max(1, (Number($lp.value) || 1) - 1);
          loadPosts(p, Number($ls.value) || 10);
        });
      }
      if ($next) {
        $next.addEventListener('click', () => {
          const p = (Number($lp.value) || 1) + 1;
          loadPosts(p, Number($ls.value) || 10);
        });
      }
    })();

    // ì´ˆê¸° ë¡œë“œ
    loadPosts(1, 10);
  </script>
</body>
</html>
