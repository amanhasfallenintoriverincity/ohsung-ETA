<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>게시물 상세</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pri:#2563eb; --ok:#065f46; --muted:#6b7280; --err:#b91c1c; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .wrap { max-width: 900px; margin: 0 auto; display: grid; gap: 1rem; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 1rem 1.25rem; }
    .hor { display:flex; gap:0.5rem; align-items:center; }
    .pill { padding:0.25rem 0.5rem; background:#eef2ff; color:#3730a3; border-radius:999px; font-size:0.85rem; }
    a { color: var(--pri); text-decoration: none; }
    .muted { color: var(--muted); font-size:0.95rem; }
    h1 { margin:0; font-size:1.25rem; }
    .meta { color:var(--muted); font-size:0.9rem; margin-top:0.35rem; }
    .content { white-space: pre-wrap; margin-top:0.6rem; }
    .btn { background:var(--pri); color:#fff; padding:0.45rem 0.7rem; border-radius:8px; border:0; cursor:pointer; }
    .danger { background: var(--err); }
    .comment { border-top:1px solid #eee; padding-top:0.6rem; margin-top:0.6rem; }
    textarea { width:100%; box-sizing:border-box; padding:0.5rem; border-radius:8px; border:1px solid #ccc; min-height:80px; }
    input[type="text"] { padding:0.4rem; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
    .muted-sm { color:var(--muted); font-size:0.85rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card hor" style="justify-content:space-between;">
      <div>
        <strong>게시물 상세</strong>
        <div class="muted">댓글 작성 및 좋아요 토글이 가능합니다.</div>
      </div>
      <div class="hor">
        <a class="btn" href="/posts_page">목록으로</a>
        <a class="btn" href="/post_page" style="background:#111827">글쓰기</a>
      </div>
    </div>

    <div class="card" id="postCard">
      <div id="postHeader">
        <h1 id="postTitle">로딩 중...</h1>
        <div class="meta">
          <span id="postAuthor" class="pill">-</span>
          <span id="postTime" class="muted" style="margin-left:0.6rem;">-</span>
        </div>
      </div>
      <div id="postContent" class="content muted-sm">로딩 중...</div>

      <div style="margin-top:0.75rem;" class="hor">
        <button id="likeBtn" class="btn">❤️ 좋아요 <span id="likeCount">0</span></button>
        <div id="likeMsg" class="muted-sm" style="margin-left:0.8rem;"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 0.6rem 0;">댓글</h3>

      <div id="commentsContainer">
        <div class="muted">로딩 중...</div>
      </div>

      <div class="comment" style="margin-top:0.8rem;">
        <form id="commentForm">
          <label class="muted-sm" for="commentContent">댓글 작성</label>
          <textarea id="commentContent" placeholder="댓글을 입력하세요"></textarea>
          <div class="hor" style="margin-top:0.5rem; justify-content:space-between;">
            <label class="hor muted-sm" style="gap:0.4rem;">
              <input id="commentAnonymous" type="checkbox" />
              <span>익명</span>
            </label>
            <div style="display:flex; gap:0.5rem;">
              <button id="commentBtn" class="btn" type="submit">작성</button>
            </div>
          </div>
          <div id="commentMsg" class="muted-sm" style="margin-top:0.5rem;"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const withSession = { credentials: 'include' };
    const postId = {{ post_id }};
    const $ = sel => document.querySelector(sel);

    function escapeHtml(s) {
      return String(s || '')
        .replace(/&/g, '&')
        .replace(/</g, '<')
        .replace(/>/g, '>');
    }

    async function loadPost() {
      try {
        const res = await fetch(`/posts/${encodeURIComponent(postId)}`, { ...withSession });
        const data = await res.json();
        if (!res.ok || data.status !== 'success') {
          $('#postTitle').textContent = '게시물을 불러올 수 없습니다.';
          $('#postContent').textContent = data.message || '오류';
          return;
        }
        const post = data.post;
        $('#postTitle').textContent = post.title || '(제목 없음)';
        $('#postAuthor').textContent = post.student_name || '익명';
        $('#postTime').textContent = post.created_at || '';
        $('#postContent').innerHTML = escapeHtml(post.content || '');
        $('#likeCount').textContent = String(post.like_count || 0);

        renderComments(data.comments || []);
      } catch (e) {
        $('#postTitle').textContent = '네트워크 오류';
        $('#postContent').textContent = '';
      }
    }

    function renderComments(comments) {
      const c = $('#commentsContainer');
      if (!comments || !comments.length) {
        c.innerHTML = '<div class="muted">댓글이 없습니다.</div>';
        return;
      }
      c.innerHTML = comments.map(cm => `
        <div style="margin-bottom:0.6rem;">
          <div class="hor" style="justify-content:space-between;">
            <div><strong>${escapeHtml(cm.student_name || '익명')}</strong></div>
            <div class="muted-sm">${escapeHtml(cm.created_at)}</div>
          </div>
          <div class="muted-sm" style="margin-top:0.25rem; white-space:pre-wrap;">${escapeHtml(cm.content)}</div>
        </div>
      `).join('');
    }

    // 댓글 작성
    $('#commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = $('#commentMsg');
      msg.textContent = '';
      $('#commentBtn').disabled = true;
      const content = $('#commentContent').value.trim();
      const is_anonymous = $('#commentAnonymous').checked;
      if (!content) {
        msg.textContent = '댓글 내용을 입력하세요.';
        $('#commentBtn').disabled = false;
        return;
      }
      try {
        const res = await fetch(`/posts/${encodeURIComponent(postId)}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          ...withSession,
          body: JSON.stringify({ content, is_anonymous })
        });
        const data = await res.json();
        if (res.status === 201 && data.status === 'success') {
          msg.textContent = '댓글 작성 성공';
          $('#commentContent').value = '';
          // reload comments
          await loadPost();
        } else {
          msg.textContent = data.message || '댓글 작성 실패';
        }
      } catch (e) {
        msg.textContent = '네트워크 오류';
      } finally {
        $('#commentBtn').disabled = false;
      }
    });

    // 좋아요 토글
    $('#likeBtn').addEventListener('click', async () => {
      $('#likeBtn').disabled = true;
      $('#likeMsg').textContent = '';
      try {
        const res = await fetch(`/posts/${encodeURIComponent(postId)}/like`, {
          method: 'POST',
          ...withSession
        });
        const data = await res.json();
        if (res.ok && data.status === 'success') {
          $('#likeCount').textContent = String(data.like_count || 0);
          $('#likeMsg').textContent = data.liked ? '좋아요 했습니다.' : '좋아요 취소';
        } else {
          $('#likeMsg').textContent = data.message || '좋아요 실패';
        }
      } catch (e) {
        $('#likeMsg').textContent = '네트워크 오류';
      } finally {
        $('#likeBtn').disabled = false;
      }
    });

    // 초기 로드
    loadPost();
  </script>
</body>
</html>
